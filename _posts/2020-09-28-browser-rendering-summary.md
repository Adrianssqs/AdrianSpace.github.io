---
layout: article
title: 浏览器渲染原理
tags: browser
key: article-browser
---

> 浏览器的内核是指支持浏览器运行的最核心的程序，分为两个部分的，一是渲染引擎，另一个是JS引擎。渲染引擎在不同的浏览器中也不是都相同的。目前市面上常见的浏览器内核可以分为这四种：Trident（IE）、Gecko（火狐）、Blink（Chrome、Opera）、Webkit（Safari）。

<!-- more -->

前言
-----

  > 本篇是通过观看 ** [浪里行舟](https://juejin.im/user/4283353031252967) ** 《深入浅出浏览器解析原理》而写下的总结手札。


浏览器工作流程
-------------

  构建DOM -> 构建CSSOM -> 构建渲染树 -> 布局 -> 绘制。

  > - CSSOM会阻塞渲染，只有当CSSOM构建完毕后才会进入下一个阶段构建渲染树。
  >
  > - 通常情况下DOM和CSSOM是并行构建的，但是当浏览器遇到一个不带defer或async属性的script标签时，DOM构建将暂停，如果此时又恰巧浏览器尚未完成CSSOM的下载和构建，由于JavaScript可以修改CSSOM，所以需要等CSSOM构建完毕后再执行JS，最后才重新DOM构建。

性能优化策略
------------

  - JS优化： `<script\>` 标签加上 `defer`属性 和 `async`属性 用于在不阻塞页面文档解析的前提下，控制脚本的下载和执行。
    - defer属性： 用于开启新的线程下载脚本文件，并使脚本在文档解析完成后执行。
    - async属性： HTML5新增属性，用于异步下载脚本文件，下载完毕立即解释执行代码。
  - CSS优化： `<link\>` 标签的 `rel`属性 中的属性值设置为 `preload` 能够让你在你的HTML页面中可以指明哪些资源是在页面加载完成后即刻需要的,最优的配置加载顺序，提高渲染性能

回流和重绘
----------

  - 重绘（Repaint）：当我们对 DOM 的修改导致了样式的变化、却并未影响其几何属性（比如修改了颜色或背景色）时，浏览器不需重新计算元 素的几何属性、直接为该元素绘制新的样式。

  - 回流（Reflow）：当我们对 DOM 的修改引发了 DOM 几何尺寸的变化（比如修改元素的宽、高或隐藏元素等）时，浏览器需要重新计算元素的几何属性（其他元素的几何属性和位置也会因此受到影响），然后再将计算的结果绘制出来。这个过程就是回流（也叫重排）。

  > **回流必定会发生重绘，重绘不一定会引发回流。**

如何减少回流、重绘
---------------

  - 使用 transform 替代 top
  - 使用 visibility 替换 display: none ，因为前者只会引起重绘，后者会引发回流（改变了布局）
  - 不要把节点的属性值放在一个循环里当成循环里的变量。
  - 不要使用 table 布局，可能很小的一个小改动会造成整个 table 的重新布局
  - 动画实现的速度的选择，动画速度越快，回流次数越多，也可以选择使用 requestAnimationFrame
  - CSS 选择符从右往左匹配查找，避免节点层级过多
  - 将频繁重绘或者回流的节点设置为图层，图层能够阻止该节点的渲染行为影响别的节点。比如对于 video 标签来说，浏览器会自动将该节点变为图层。
